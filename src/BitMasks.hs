{-# LANGUAGE TemplateHaskell #-}
{-# LANGUAGE BinaryLiterals #-}
module BitMasks where
import Data.Word(Word64)
import Data.Bits(unsafeShiftL, unsafeShiftR, (.|.), FiniteBits (countTrailingZeros))
import Language.Haskell.TH
    ( mkName, Exp, Clause(Clause), Q, Dec(FunD), Body(NormalB) )
import Model (showBits)
import Data.Traversable (for)
import BitFuncs (w64Tow8L)
import Templates (colMasksXXXXXXXX, mirrorBitsY, kingTableT, knightTableT)

-- | Masks out the most significant bit of every byte
firstBitMask :: Word64
firstBitMask = 0x7F7F7F7F7F7F7F7F

-- | Masks out everything except the most significant bit of every byte
firstBits :: Word64
firstBits = 0x8080808080808080

-- | Masks out the least significant bit of every byte
lastBitMask :: Word64
lastBitMask = 0xFEFEFEFEFEFEFEFE

-- | Masks out everything except the least significant bit of every byte
lastBits :: Word64
lastBits = 0x0101010101010101

-- | Masks out the bottom column of bits
bottomRowMask :: Word64
bottomRowMask = 0x00000000000000FF

-- | Precomputed Masks
genColMasks :: Q [Dec]
genColMasks = for [0..255] mkColMaskExp
  where mkColMaskExp ith = do
            mask <- colMasksXXXXXXXX ith
            let name = mkName $ "colMask" ++ showBits ith 8
            return $ FunD name [Clause [] (NormalB mask) []]

-- | Masks out the rows in the given Word64
rowMask :: Word64 -> Q Exp
rowMask 0 = [|0|]
rowMask n = do
    let row = countTrailingZeros n
    [|(bottomRowMask `unsafeShiftL` (row*8)) .|. $(rowMask ((n `unsafeShiftR` (row+1)) `unsafeShiftL` (row+1)))|]

bishopTable :: Word64 -> Word64
bishopTable 0 =  0b1000000001000000001000000001000000001000000001000000001000000000
bishopTable 1 =  0b0000000010000000010000000010000000010000000010000000010100000000
bishopTable 2 =  0b0000000000000000100000000100000000100000000100010000101000000000
bishopTable 3 =  0b0000000000000000000000001000000001000001001000100001010000000000
bishopTable 4 =  0b0000000000000000000000000000000110000010010001000010100000000000
bishopTable 5 =  0b0000000000000000000000010000001000000100100010000101000000000000
bishopTable 6 =  0b0000000000000001000000100000010000001000000100001010000000000000
bishopTable 7 =  0b0000000100000010000001000000100000010000001000000100000000000000
bishopTable 8 =  0b0100000000100000000100000000100000000100000000100000000000000010
bishopTable 9 =  0b1000000001000000001000000001000000001000000001010000000000000101
bishopTable 10 = 0b0000000010000000010000000010000000010001000010100000000000001010
bishopTable 11 = 0b0000000000000000100000000100000100100010000101000000000000010100
bishopTable 12 = 0b0000000000000000000000011000001001000100001010000000000000101000
bishopTable 13 = 0b0000000000000001000000100000010010001000010100000000000001010000
bishopTable 14 = 0b0000000100000010000001000000100000010000101000000000000010100000
bishopTable 15 = 0b0000001000000100000010000001000000100000010000000000000001000000
bishopTable 16 = 0b0010000000010000000010000000010000000010000000000000001000000100
bishopTable 17 = 0b0100000000100000000100000000100000000101000000000000010100001000
bishopTable 18 = 0b1000000001000000001000000001000100001010000000000000101000010001
bishopTable 19 = 0b0000000010000000010000010010001000010100000000000001010000100010
bishopTable 20 = 0b0000000000000001100000100100010000101000000000000010100001000100
bishopTable 21 = 0b0000000100000010000001001000100001010000000000000101000010001000
bishopTable 22 = 0b0000001000000100000010000001000010100000000000001010000000010000
bishopTable 23 = 0b0000010000001000000100000010000001000000000000000100000000100000
bishopTable 24 = 0b0001000000001000000001000000001000000000000000100000010000001000
bishopTable 25 = 0b0010000000010000000010000000010100000000000001010000100000010000
bishopTable 26 = 0b0100000000100000000100010000101000000000000010100001000100100000
bishopTable 27 = 0b1000000001000001001000100001010000000000000101000010001001000001
bishopTable 28 = 0b0000000110000010010001000010100000000000001010000100010010000010
bishopTable 29 = 0b0000001000000100100010000101000000000000010100001000100000000100
bishopTable 30 = 0b0000010000001000000100001010000000000000101000000001000000001000
bishopTable 31 = 0b0000100000010000001000000100000000000000010000000010000000010000
bishopTable 32 = $(mirrorBitsY 0b0001000000001000000001000000001000000000000000100000010000001000)
bishopTable 33 = $(mirrorBitsY 0b0010000000010000000010000000010100000000000001010000100000010000)
bishopTable 34 = $(mirrorBitsY 0b0100000000100000000100010000101000000000000010100001000100100000)
bishopTable 35 = $(mirrorBitsY 0b1000000001000001001000100001010000000000000101000010001001000001)
bishopTable 36 = $(mirrorBitsY 0b0000000110000010010001000010100000000000001010000100010010000010)
bishopTable 37 = $(mirrorBitsY 0b0000001000000100100010000101000000000000010100001000100000000100)
bishopTable 38 = $(mirrorBitsY 0b0000010000001000000100001010000000000000101000000001000000001000)
bishopTable 39 = $(mirrorBitsY 0b0000100000010000001000000100000000000000010000000010000000010000)
bishopTable 40 = $(mirrorBitsY 0b0010000000010000000010000000010000000010000000000000001000000100)
bishopTable 41 = $(mirrorBitsY 0b0100000000100000000100000000100000000101000000000000010100001000)
bishopTable 42 = $(mirrorBitsY 0b1000000001000000001000000001000100001010000000000000101000010001)
bishopTable 43 = $(mirrorBitsY 0b0000000010000000010000010010001000010100000000000001010000100010)
bishopTable 44 = $(mirrorBitsY 0b0000000000000001100000100100010000101000000000000010100001000100)
bishopTable 45 = $(mirrorBitsY 0b0000000100000010000001001000100001010000000000000101000010001000)
bishopTable 46 = $(mirrorBitsY 0b0000001000000100000010000001000010100000000000001010000000010000)
bishopTable 47 = $(mirrorBitsY 0b0000010000001000000100000010000001000000000000000100000000100000)
bishopTable 48 = $(mirrorBitsY 0b0100000000100000000100000000100000000100000000100000000000000010)
bishopTable 49 = $(mirrorBitsY 0b1000000001000000001000000001000000001000000001010000000000000101)
bishopTable 50 = $(mirrorBitsY 0b0000000010000000010000000010000000010001000010100000000000001010)
bishopTable 51 = $(mirrorBitsY 0b0000000000000000100000000100000100100010000101000000000000010100)
bishopTable 52 = $(mirrorBitsY 0b0000000000000000000000011000001001000100001010000000000000101000)
bishopTable 53 = $(mirrorBitsY 0b0000000000000001000000100000010010001000010100000000000001010000)
bishopTable 54 = $(mirrorBitsY 0b0000000100000010000001000000100000010000101000000000000010100000)
bishopTable 55 = $(mirrorBitsY 0b0000001000000100000010000001000000100000010000000000000001000000)
bishopTable 56 = $(mirrorBitsY 0b1000000001000000001000000001000000001000000001000000001000000000)
bishopTable 57 = $(mirrorBitsY 0b0000000010000000010000000010000000010000000010000000010100000000)
bishopTable 58 = $(mirrorBitsY 0b0000000000000000100000000100000000100000000100010000101000000000)
bishopTable 59 = $(mirrorBitsY 0b0000000000000000000000001000000001000001001000100001010000000000)
bishopTable 60 = $(mirrorBitsY 0b0000000000000000000000000000000110000010010001000010100000000000)
bishopTable 61 = $(mirrorBitsY 0b0000000000000000000000010000001000000100100010000101000000000000)
bishopTable 62 = $(mirrorBitsY 0b0000000000000001000000100000010000001000000100001010000000000000)
bishopTable 63 = $(mirrorBitsY 0b0000000100000010000001000000100000010000001000000100000000000000)
bishopTable _ = error "bishopTable: invalid index"

rookTable :: Word64 -> Word64
rookTable 0 = 0b0000000100000001000000010000000100000001000000010000000111111110
rookTable 1 = 0b0000001000000010000000100000001000000010000000100000001011111101
rookTable 2 = 0b0000010000000100000001000000010000000100000001000000010011111011
rookTable 3 = 0b0000100000001000000010000000100000001000000010000000100011110111
rookTable 4 = 0b0001000000010000000100000001000000010000000100000001000011101111
rookTable 5 = 0b0010000000100000001000000010000000100000001000000010000011011111
rookTable 6 = 0b0100000001000000010000000100000001000000010000000100000010111111
rookTable 7 = 0b1000000010000000100000001000000010000000100000001000000001111111
rookTable 8 =  0b0000000100000001000000010000000100000001000000011111111000000001
rookTable 9 =  0b0000001000000010000000100000001000000010000000101111110100000010
rookTable 10 = 0b0000010000000100000001000000010000000100000001001111101100000100
rookTable 11 = 0b0000100000001000000010000000100000001000000010001111011100001000
rookTable 12 = 0b0001000000010000000100000001000000010000000100001110111100010000
rookTable 13 = 0b0010000000100000001000000010000000100000001000001101111100100000
rookTable 14 = 0b0100000001000000010000000100000001000000010000001011111101000000
rookTable 15 = 0b1000000010000000100000001000000010000000100000000111111110000000
rookTable 16 = 0b0000000100000001000000010000000100000001111111100000000100000001
rookTable 17 = 0b0000001000000010000000100000001000000010111111010000001000000010
rookTable 18 = 0b0000010000000100000001000000010000000100111110110000010000000100
rookTable 19 = 0b0000100000001000000010000000100000001000111101110000100000001000
rookTable 20 = 0b0001000000010000000100000001000000010000111011110001000000010000
rookTable 21 = 0b0010000000100000001000000010000000100000110111110010000000100000
rookTable 22 = 0b0100000001000000010000000100000001000000101111110100000001000000
rookTable 23 = 0b1000000010000000100000001000000010000000011111111000000010000000
rookTable 24 = 0b0000000100000001000000010000000111111110000000010000000100000001
rookTable 25 = 0b0000001000000010000000100000001011111101000000100000001000000010
rookTable 26 = 0b0000010000000100000001000000010011111011000001000000010000000100
rookTable 27 = 0b0000100000001000000010000000100011110111000010000000100000001000
rookTable 28 = 0b0001000000010000000100000001000011101111000100000001000000010000
rookTable 29 = 0b0010000000100000001000000010000011011111001000000010000000100000
rookTable 30 = 0b0100000001000000010000000100000010111111010000000100000001000000
rookTable 31 = 0b1000000010000000100000001000000001111111100000001000000010000000
rookTable 32 = 0b0000000100000001000000011111111000000001000000010000000100000001
rookTable 33 = 0b0000001000000010000000101111110100000010000000100000001000000010
rookTable 34 = 0b0000010000000100000001001111101100000100000001000000010000000100
rookTable 35 = 0b0000100000001000000010001111011100001000000010000000100000001000
rookTable 36 = 0b0001000000010000000100001110111100010000000100000001000000010000
rookTable 37 = 0b0010000000100000001000001101111100100000001000000010000000100000
rookTable 38 = 0b0100000001000000010000001011111101000000010000000100000001000000
rookTable 39 = 0b1000000010000000100000000111111110000000100000001000000010000000
rookTable 40 = 0b0000000100000001111111100000000100000001000000010000000100000001
rookTable 41 = 0b0000001000000010111111010000001000000010000000100000001000000010
rookTable 42 = 0b0000010000000100111110110000010000000100000001000000010000000100
rookTable 43 = 0b0000100000001000111101110000100000001000000010000000100000001000
rookTable 44 = 0b0001000000010000111011110001000000010000000100000001000000010000
rookTable 45 = 0b0010000000100000110111110010000000100000001000000010000000100000
rookTable 46 = 0b0100000001000000101111110100000001000000010000000100000001000000
rookTable 47 = 0b1000000010000000011111111000000010000000100000001000000010000000
rookTable 48 = 0b0000000111111110000000010000000100000001000000010000000100000001
rookTable 49 = 0b0000001011111101000000100000001000000010000000100000001000000010
rookTable 50 = 0b0000010011111011000001000000010000000100000001000000010000000100
rookTable 51 = 0b0000100011110111000010000000100000001000000010000000100000001000
rookTable 52 = 0b0001000011101111000100000001000000010000000100000001000000010000
rookTable 53 = 0b0010000011011111001000000010000000100000001000000010000000100000
rookTable 54 = 0b0100000010111111010000000100000001000000010000000100000001000000
rookTable 55 = 0b1000000001111111100000001000000010000000100000001000000010000000
rookTable 56 = 0b1111111000000001000000010000000100000001000000010000000100000001
rookTable 57 = 0b1111110100000010000000100000001000000010000000100000001000000010
rookTable 58 = 0b1111101100000100000001000000010000000100000001000000010000000100
rookTable 59 = 0b1111011100001000000010000000100000001000000010000000100000001000
rookTable 60 = 0b1110111100010000000100000001000000010000000100000001000000010000
rookTable 61 = 0b1101111100100000001000000010000000100000001000000010000000100000
rookTable 62 = 0b1011111101000000010000000100000001000000010000000100000001000000
rookTable 63 = 0b0111111110000000100000001000000010000000100000001000000010000000
rookTable _ = error "rookTable: invalid index"

kingTable :: Word64 -> Word64
kingTable 0 = $(kingTableT 0)
kingTable 1 = $(kingTableT 1)
kingTable 2 = $(kingTableT 2)
kingTable 3 = $(kingTableT 3)
kingTable 4 = $(kingTableT 4)
kingTable 5 = $(kingTableT 5)
kingTable 6 = $(kingTableT 6)
kingTable 7 = $(kingTableT 7)
kingTable 8 =  $(kingTableT 8)
kingTable 9 =  $(kingTableT 9)
kingTable 10 = $(kingTableT 10)
kingTable 11 = $(kingTableT 11)
kingTable 12 = $(kingTableT 12)
kingTable 13 = $(kingTableT 13)
kingTable 14 = $(kingTableT 14)
kingTable 15 = $(kingTableT 15)
kingTable 16 = $(kingTableT 16)
kingTable 17 = $(kingTableT 17)
kingTable 18 = $(kingTableT 18)
kingTable 19 = $(kingTableT 19)
kingTable 20 = $(kingTableT 20)
kingTable 21 = $(kingTableT 21)
kingTable 22 = $(kingTableT 22)
kingTable 23 = $(kingTableT 23)
kingTable 24 = $(kingTableT 24)
kingTable 25 = $(kingTableT 25)
kingTable 26 = $(kingTableT 26)
kingTable 27 = $(kingTableT 27)
kingTable 28 = $(kingTableT 28)
kingTable 29 = $(kingTableT 29)
kingTable 30 = $(kingTableT 30)
kingTable 31 = $(kingTableT 31)
kingTable 32 = $(kingTableT 32)
kingTable 33 = $(kingTableT 33)
kingTable 34 = $(kingTableT 34)
kingTable 35 = $(kingTableT 35)
kingTable 36 = $(kingTableT 36)
kingTable 37 = $(kingTableT 37)
kingTable 38 = $(kingTableT 38)
kingTable 39 = $(kingTableT 39)
kingTable 40 = $(kingTableT 40)
kingTable 41 = $(kingTableT 41)
kingTable 42 = $(kingTableT 42)
kingTable 43 = $(kingTableT 43)
kingTable 44 = $(kingTableT 44)
kingTable 45 = $(kingTableT 45)
kingTable 46 = $(kingTableT 46)
kingTable 47 = $(kingTableT 47)
kingTable 48 = $(kingTableT 48)
kingTable 49 = $(kingTableT 49)
kingTable 50 = $(kingTableT 50)
kingTable 51 = $(kingTableT 51)
kingTable 52 = $(kingTableT 52)
kingTable 53 = $(kingTableT 53)
kingTable 54 = $(kingTableT 54)
kingTable 55 = $(kingTableT 55)
kingTable 56 = $(kingTableT 56)
kingTable 57 = $(kingTableT 57)
kingTable 58 = $(kingTableT 58)
kingTable 59 = $(kingTableT 59)
kingTable 60 = $(kingTableT 60)
kingTable 61 = $(kingTableT 61)
kingTable 62 = $(kingTableT 62)
kingTable 63 = $(kingTableT 63)
kingTable _ = error "kingTable: invalid index"

knightTable :: Word64 -> Word64
knightTable 0 = $(knightTableT 0)
knightTable 1 = $(knightTableT 1)
knightTable 2 = $(knightTableT 2)
knightTable 3 = $(knightTableT 3)
knightTable 4 = $(knightTableT 4)
knightTable 5 = $(knightTableT 5)
knightTable 6 = $(knightTableT 6)
knightTable 7 = $(knightTableT 7)
knightTable 8 =  $(knightTableT 8)
knightTable 9 =  $(knightTableT 9)
knightTable 10 = $(knightTableT 10)
knightTable 11 = $(knightTableT 11)
knightTable 12 = $(knightTableT 12)
knightTable 13 = $(knightTableT 13)
knightTable 14 = $(knightTableT 14)
knightTable 15 = $(knightTableT 15)
knightTable 16 = $(knightTableT 16)
knightTable 17 = $(knightTableT 17)
knightTable 18 = $(knightTableT 18)
knightTable 19 = $(knightTableT 19)
knightTable 20 = $(knightTableT 20)
knightTable 21 = $(knightTableT 21)
knightTable 22 = $(knightTableT 22)
knightTable 23 = $(knightTableT 23)
knightTable 24 = $(knightTableT 24)
knightTable 25 = $(knightTableT 25)
knightTable 26 = $(knightTableT 26)
knightTable 27 = $(knightTableT 27)
knightTable 28 = $(knightTableT 28)
knightTable 29 = $(knightTableT 29)
knightTable 30 = $(knightTableT 30)
knightTable 31 = $(knightTableT 31)
knightTable 32 = $(knightTableT 32)
knightTable 33 = $(knightTableT 33)
knightTable 34 = $(knightTableT 34)
knightTable 35 = $(knightTableT 35)
knightTable 36 = $(knightTableT 36)
knightTable 37 = $(knightTableT 37)
knightTable 38 = $(knightTableT 38)
knightTable 39 = $(knightTableT 39)
knightTable 40 = $(knightTableT 40)
knightTable 41 = $(knightTableT 41)
knightTable 42 = $(knightTableT 42)
knightTable 43 = $(knightTableT 43)
knightTable 44 = $(knightTableT 44)
knightTable 45 = $(knightTableT 45)
knightTable 46 = $(knightTableT 46)
knightTable 47 = $(knightTableT 47)
knightTable 48 = $(knightTableT 48)
knightTable 49 = $(knightTableT 49)
knightTable 50 = $(knightTableT 50)
knightTable 51 = $(knightTableT 51)
knightTable 52 = $(knightTableT 52)
knightTable 53 = $(knightTableT 53)
knightTable 54 = $(knightTableT 54)
knightTable 55 = $(knightTableT 55)
knightTable 56 = $(knightTableT 56)
knightTable 57 = $(knightTableT 57)
knightTable 58 = $(knightTableT 58)
knightTable 59 = $(knightTableT 59)
knightTable 60 = $(knightTableT 60)
knightTable 61 = $(knightTableT 61)
knightTable 62 = $(knightTableT 62)
knightTable 63 = $(knightTableT 63)
knightTable _ = error "knightTable: invalid index"

whiteKnightPunishment :: Word64
whiteKnightPunishment = 0x00008181818181FF
blackKnightPunishment :: Word64
blackKnightPunishment = 0xFF81818181810000
whiteWBishopFianchettoSpot :: Word64
whiteWBishopFianchettoSpot = 0x0000000000000200
whiteWPawnsForFianchetto :: Word64
whiteWPawnsForFianchetto = 0x0000000000020500
whiteBBishopFianchettoSpot :: Word64
whiteBBishopFianchettoSpot = 0x0000000000004000
whiteBPawnsForFianchetto :: Word64
whiteBPawnsForFianchetto = 0x000000000040A000
blackWBishopFianchettoSpot :: Word64
blackWBishopFianchettoSpot = 0x0040000000000000
blackWPawnsForFianchetto :: Word64
blackWPawnsForFianchetto = 0x00A0400000000000
blackBBishopFianchettoSpot :: Word64
blackBBishopFianchettoSpot = 0x00002000000000000
blackBPawnsForFianchetto :: Word64
blackBPawnsForFianchetto = 0x0005020000000000